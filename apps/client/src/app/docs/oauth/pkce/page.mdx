import { Shield, AlertTriangle } from 'lucide-react'

# PKCE (Proof Key for Code Exchange)

## PKCEë€?

PKCE (Proof Key for Code Exchange, RFC 7636)ëŠ” OAuth 2.0 Authorization Code Flowì˜ ë³´ì•ˆì„ ê°•í™”í•˜ëŠ” í™•ì¥ í‘œì¤€ì…ë‹ˆë‹¤. ì›ë˜ëŠ” ëª¨ë°”ì¼ ì•±ê³¼ ê°™ì€ Public Clientë¥¼ ë³´í˜¸í•˜ê¸° ìœ„í•´ ì„¤ê³„ë˜ì—ˆì§€ë§Œ, í˜„ì¬ëŠ” ë§ì€ OAuth í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì„ íƒì ìœ¼ë¡œ ì‚¬ìš©ë˜ê³  ìˆìŠµë‹ˆë‹¤.

### ë„ì… ë°°ê²½

ì „í†µì ì¸ Authorization Code Flowì—ì„œëŠ” `client_secret`ì„ ì‚¬ìš©í•˜ì—¬ í´ë¼ì´ì–¸íŠ¸ë¥¼ ì¸ì¦í•©ë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ ì´ ë°©ì‹ì€ ë‹¤ìŒê³¼ ê°™ì€ í•œê³„ê°€ ìˆìŠµë‹ˆë‹¤:

#### client_secret ë°©ì‹ì˜ ë¬¸ì œì 

1. **í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ ë…¸ì¶œ ìœ„í—˜**
   - ë¸Œë¼ìš°ì €ë‚˜ ëª¨ë°”ì¼ ì•±ì—ì„œ `client_secret`ì„ ì•ˆì „í•˜ê²Œ ë³´ê´€í•˜ê¸° ì–´ë ¤ì›€
   - ë””ì»´íŒŒì¼ì´ë‚˜ ì†ŒìŠ¤ ì½”ë“œ ë¶„ì„ìœ¼ë¡œ ì‰½ê²Œ ì¶”ì¶œ ê°€ëŠ¥

2. **Authorization Code Injection ê³µê²©**
   - ì•…ì˜ì ì¸ ì•±ì´ ê°€ë¡œì±ˆ Authorization Codeë¥¼ ìì‹ ì˜ `client_secret`ìœ¼ë¡œ êµí™˜ ê°€ëŠ¥
   - ì‚¬ìš©ì ê³„ì • íƒˆì·¨ ìœ„í—˜

3. **Public Clientì˜ ë³´ì•ˆ ì·¨ì•½ì„±**
   - SPA, ëª¨ë°”ì¼ ì•± ë“±ì—ì„œëŠ” secret ê´€ë¦¬ê°€ ì‚¬ì‹¤ìƒ ë¶ˆê°€ëŠ¥
   - ëª¨ë“  ì‚¬ìš©ìê°€ ë™ì¼í•œ `client_secret`ì„ ê³µìœ í•˜ê²Œ ë¨

### PKCEì˜ í•´ê²° ë°©ë²•

PKCEëŠ” `client_secret` ëŒ€ì‹  **ë™ì ìœ¼ë¡œ ìƒì„±ë˜ëŠ” ì¼íšŒì„± ê²€ì¦ì**ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤:

- ê° ì¸ì¦ ìš”ì²­ë§ˆë‹¤ ìƒˆë¡œìš´ `code_verifier` ìƒì„±
- Authorization Codeë¥¼ íƒˆì·¨í•˜ë”ë¼ë„ ì›ë³¸ `code_verifier` ì—†ì´ëŠ” í† í° êµí™˜ ë¶ˆê°€ëŠ¥
- í´ë¼ì´ì–¸íŠ¸ì— í•˜ë“œì½”ë”©ëœ secretì´ ì—†ìœ¼ë¯€ë¡œ ë…¸ì¶œ ìœ„í—˜ ì—†ìŒ

<div className="border-l-4 border-blue-500 bg-blue-50 dark:bg-blue-900/20 p-4 rounded my-6">
  <div className="flex items-start gap-3">
    <Shield className="h-5 w-5 text-blue-500 shrink-0 mt-0.5" />
    <div>
      <div className="font-semibold text-blue-900 dark:text-blue-100 mb-1">
        PKCE vs client_secret
      </div>
      <div className="text-blue-800 dark:text-blue-200 text-sm space-y-2">
        <div><strong>PKCE:</strong> ê° ìš”ì²­ë§ˆë‹¤ ìƒˆë¡œìš´ ê²€ì¦ì ìƒì„± â†’ ì¼íšŒì„±, ë™ì , ì•ˆì „</div>
        <div><strong>client_secret:</strong> ëª¨ë“  ìš”ì²­ì— ë™ì¼í•œ secret ì‚¬ìš© â†’ ì˜êµ¬ì , ì •ì , ë…¸ì¶œ ìœ„í—˜</div>
      </div>
    </div>
  </div>
</div>

## PKCE í”Œë¡œìš°

PKCEëŠ” Authorization Code Flowì— ë‘ ê°€ì§€ íŒŒë¼ë¯¸í„°ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤:

- **code_verifier**: 43-128ìì˜ ëœë¤ ë¬¸ìì—´ (í´ë¼ì´ì–¸íŠ¸ê°€ ì•ˆì „í•˜ê²Œ ì €ì¥)
- **code_challenge**: `code_verifier`ì˜ SHA-256 í•´ì‹œ (ì„œë²„ë¡œ ì „ì†¡)

### í”Œë¡œìš° ë‹¤ì´ì–´ê·¸ë¨

```mermaid
sequenceDiagram
    participant C as í´ë¼ì´ì–¸íŠ¸
    participant O as OAuth ì„œë²„

    Note over C: 1. code_verifier ìƒì„±
    C->>C: verifier = random(43-128ì)

    Note over C: 2. code_challenge ìƒì„±
    C->>C: challenge = SHA256(verifier)

    Note over C,O: 3. Authorization ìš”ì²­
    C->>O: /authorize + code_challenge
    O-->>C: Authorization Code

    Note over C,O: 4. Token êµí™˜
    C->>O: /token + code + code_verifier

    Note over O: 5. ê²€ì¦
    O->>O: SHA256(code_verifier) == code_challenge?

    alt ê²€ì¦ ì„±ê³µ
        O-->>C: Access Token + Refresh Token
    else ê²€ì¦ ì‹¤íŒ¨
        O-->>C: Error (invalid_grant)
    end
```

### ë‹¨ê³„ë³„ ìƒì„¸ ì„¤ëª…

#### 1ë‹¨ê³„: code_verifier ìƒì„±

í´ë¼ì´ì–¸íŠ¸ê°€ 43-128ì ê¸¸ì´ì˜ ì•ˆì „í•œ ëœë¤ ë¬¸ìì—´ì„ ìƒì„±í•©ë‹ˆë‹¤.

- **í—ˆìš© ë¬¸ì**: `A-Z`, `a-z`, `0-9`, `-`, `.`, `_`, `~` (unreserved characters)
- **ê¶Œì¥ ê¸¸ì´**: 43ì ì´ìƒ
- **ìƒì„± ë°©ë²•**: ì•”í˜¸í•™ì ìœ¼ë¡œ ì•ˆì „í•œ ë‚œìˆ˜ ìƒì„±ê¸°(CSPRNG) ì‚¬ìš© í•„ìˆ˜

```javascript
// ì˜¬ë°”ë¥¸ ì˜ˆì‹œ
const array = new Uint8Array(32);
crypto.getRandomValues(array); // CSPRNG
const codeVerifier = base64UrlEncode(array);

// ì˜ëª»ëœ ì˜ˆì‹œ (ì‚¬ìš© ê¸ˆì§€)
const codeVerifier = Math.random().toString(36); // ì˜ˆì¸¡ ê°€ëŠ¥
```

#### 2ë‹¨ê³„: code_challenge ìƒì„±

`code_verifier`ë¥¼ SHA-256 í•´ì‹±í•˜ê³  Base64URL ì¸ì½”ë”©í•©ë‹ˆë‹¤.

```javascript
async function generateCodeChallenge(verifier) {
  const encoder = new TextEncoder();
  const data = encoder.encode(verifier);
  const hash = await crypto.subtle.digest('SHA-256', data);
  return base64UrlEncode(new Uint8Array(hash));
}
```

**ì¤‘ìš”**: `code_challenge_method`ëŠ” ë°˜ë“œì‹œ `S256` (SHA-256)ì„ ì‚¬ìš©í•˜ì„¸ìš”. `plain` ë°©ì‹ì€ ë³´ì•ˆìƒ ì·¨ì•½í•©ë‹ˆë‹¤.

#### 3ë‹¨ê³„: Authorization ìš”ì²­

ìƒì„±í•œ `code_challenge`ë¥¼ Authorization ìš”ì²­ì— í¬í•¨í•©ë‹ˆë‹¤.

```http
POST /v1/oauth/code
Content-Type: application/json

{
  "email": "user@example.com",
  "password": "password",
  "client_id": "your-client-id",
  "redirect_uri": "https://your-app.com/callback",
  "code_challenge": "E9Melhoa2OwvFrEMTJguCHaoeK1t8URWbuGJSstw-cM",
  "code_challenge_method": "S256"
}
```

ì„œë²„ëŠ” `code_challenge`ë¥¼ Authorization Codeì™€ í•¨ê»˜ ì €ì¥í•©ë‹ˆë‹¤.

#### 4ë‹¨ê³„: Token êµí™˜

Authorization Codeì™€ í•¨ê»˜ ì›ë³¸ `code_verifier`ë¥¼ ì „ì†¡í•©ë‹ˆë‹¤.

```http
POST /v1/oauth/token
Content-Type: application/json

{
  "grant_type": "authorization_code",
  "code": "abc123def456",
  "client_id": "your-client-id",
  "redirect_uri": "https://your-app.com/callback",
  "code_verifier": "dBjftJeZ4CVP-mB92K27uhbUJU1p1r_wW1gFWFOEjXk"
}
```

#### 5ë‹¨ê³„: ì„œë²„ ì¸¡ ê²€ì¦

ì„œë²„ê°€ ë‹¤ìŒì„ ê²€ì¦í•©ë‹ˆë‹¤:

1. `code_verifier`ë¥¼ SHA-256 í•´ì‹±
2. ê²°ê³¼ë¥¼ ì €ì¥ëœ `code_challenge`ì™€ ë¹„êµ
3. ì¼ì¹˜í•˜ë©´ í† í° ë°œê¸‰, ë¶ˆì¼ì¹˜í•˜ë©´ ê±°ë¶€

```
SHA256(code_verifier) == stored_code_challenge ?
  â†’ í† í° ë°œê¸‰ : 401 Unauthorized
```

## êµ¬í˜„ ê°€ì´ë“œ

### JavaScript/TypeScript êµ¬í˜„

ì™„ì „í•œ PKCE êµ¬í˜„ ì˜ˆì œì…ë‹ˆë‹¤.

```typescript
// Base64URL ì¸ì½”ë”© í•¨ìˆ˜
function base64UrlEncode(array: Uint8Array): string {
  const base64 = btoa(String.fromCharCode(...array));
  return base64
    .replace(/\+/g, '-')
    .replace(/\//g, '_')
    .replace(/=+$/, '');
}

// code_verifier ìƒì„± (43-128ì)
function generateCodeVerifier(): string {
  const array = new Uint8Array(32); // 32 bytes = 256 bits
  crypto.getRandomValues(array);
  return base64UrlEncode(array);
}

// code_challenge ìƒì„± (SHA-256)
async function generateCodeChallenge(verifier: string): Promise<string> {
  const encoder = new TextEncoder();
  const data = encoder.encode(verifier);
  const hash = await crypto.subtle.digest('SHA-256', data);
  return base64UrlEncode(new Uint8Array(hash));
}

// ì „ì²´ í”Œë¡œìš°
async function initiateOAuthWithPKCE() {
  // 1. code_verifier ìƒì„± ë° ì €ì¥
  const codeVerifier = generateCodeVerifier();
  const codeChallenge = await generateCodeChallenge(codeVerifier);

  // ì•ˆì „í•œ ì €ì¥ì†Œì— ì €ì¥ (ì˜ˆ: httpOnly ì¿ í‚¤)
  sessionStorage.setItem('oauth_code_verifier', codeVerifier);

  // 2. Authorization ìš”ì²­
  const response = await fetch('https://oauth.data.hellogsm.kr/v1/oauth/code', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      email: 'user@example.com',
      password: 'password',
      client_id: 'your-client-id',
      redirect_uri: 'https://your-app.com/callback',
      code_challenge: codeChallenge,
      code_challenge_method: 'S256',
    }),
  });

  const { code } = await response.json();

  // 3. Token êµí™˜
  const storedVerifier = sessionStorage.getItem('oauth_code_verifier');
  const tokenResponse = await fetch('https://oauth.data.hellogsm.kr/v1/oauth/token', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      grant_type: 'authorization_code',
      code,
      client_id: 'your-client-id',
      redirect_uri: 'https://your-app.com/callback',
      code_verifier: storedVerifier,
    }),
  });

  const tokens = await tokenResponse.json();

  // 4. code_verifier ì‚­ì œ (ì¼íšŒì„±)
  sessionStorage.removeItem('oauth_code_verifier');

  return tokens;
}
```

### Next.js Middleware ì˜ˆì œ

Next.js í™˜ê²½ì—ì„œ PKCEë¥¼ êµ¬í˜„í•˜ëŠ” ë°©ë²•ì…ë‹ˆë‹¤. ì„œë²„ ì¸¡ì—ì„œ `code_verifier`ë¥¼ ê´€ë¦¬í•˜ì—¬ ë³´ì•ˆì„ ê°•í™”í•©ë‹ˆë‹¤.

```typescript
// app/api/auth/login/route.ts
import { cookies } from 'next/headers';
import { NextRequest, NextResponse } from 'next/server';

export async function POST(request: NextRequest) {
  const { email, password } = await request.json();

  // 1. code_verifier ìƒì„±
  const codeVerifier = generateCodeVerifier();
  const codeChallenge = await generateCodeChallenge(codeVerifier);

  // 2. httpOnly ì¿ í‚¤ì— ì €ì¥ (XSS ë°©ì§€)
  cookies().set('oauth_code_verifier', codeVerifier, {
    httpOnly: true,
    secure: true,
    sameSite: 'lax',
    maxAge: 600, // 10ë¶„
  });

  // 3. Authorization Code ìš”ì²­
  const response = await fetch('https://oauth.data.hellogsm.kr/v1/oauth/code', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      email,
      password,
      client_id: process.env.OAUTH_CLIENT_ID,
      redirect_uri: `${process.env.NEXT_PUBLIC_BASE_URL}/api/auth/callback`,
      code_challenge: codeChallenge,
      code_challenge_method: 'S256',
    }),
  });

  const { code } = await response.json();
  return NextResponse.json({ code });
}
```

```typescript
// app/api/auth/callback/route.ts
import { cookies } from 'next/headers';
import { NextRequest, NextResponse } from 'next/server';

export async function GET(request: NextRequest) {
  const code = request.nextUrl.searchParams.get('code');

  // 1. ì €ì¥ëœ code_verifier ê°€ì ¸ì˜¤ê¸°
  const codeVerifier = cookies().get('oauth_code_verifier')?.value;

  if (!codeVerifier) {
    return NextResponse.json(
      { error: 'code_verifier not found' },
      { status: 400 }
    );
  }

  // 2. Token êµí™˜
  const response = await fetch('https://oauth.data.hellogsm.kr/v1/oauth/token', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      grant_type: 'authorization_code',
      code,
      client_id: process.env.OAUTH_CLIENT_ID,
      redirect_uri: `${process.env.NEXT_PUBLIC_BASE_URL}/api/auth/callback`,
      code_verifier: codeVerifier,
    }),
  });

  const tokens = await response.json();

  // 3. code_verifier ì‚­ì œ (ì¼íšŒì„±)
  cookies().delete('oauth_code_verifier');

  // 4. í† í°ì„ httpOnly ì¿ í‚¤ì— ì €ì¥
  cookies().set('access_token', tokens.accessToken, {
    httpOnly: true,
    secure: true,
    sameSite: 'lax',
    maxAge: 3600, // 1ì‹œê°„
  });

  cookies().set('refresh_token', tokens.refreshToken, {
    httpOnly: true,
    secure: true,
    sameSite: 'lax',
    maxAge: 30 * 24 * 3600, // 30ì¼
  });

  return NextResponse.redirect(new URL('/dashboard', request.url));
}
```

## ë³´ì•ˆ ê³ ë ¤ì‚¬í•­

### code_verifier ì €ì¥ ë°©ë²•

<div className="border-l-4 border-blue-500 bg-blue-50 dark:bg-blue-900/20 p-4 rounded my-6">
  <div className="flex items-start gap-3">
    <Shield className="h-5 w-5 text-blue-600 dark:text-blue-500 shrink-0 mt-0.5" />
    <div>
      <div className="font-semibold text-blue-900 dark:text-blue-100 mb-1">
        code_verifier ë³´ì•ˆ
      </div>
      <div className="text-blue-800 dark:text-blue-200 text-sm">
        <code className="mx-1 px-1.5 py-0.5 bg-blue-100 dark:bg-blue-800 rounded">code_verifier</code>ëŠ” ì•ˆì „í•˜ê²Œ ì €ì¥ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
        ë¸Œë¼ìš°ì € í™˜ê²½ì—ì„œëŠ” httpOnly ì¿ í‚¤ë¥¼ ì‚¬ìš©í•˜ì‹œë©´ ë” ì•ˆì „í•©ë‹ˆë‹¤.
        localStorageë‚˜ sessionStorageëŠ” XSS ê³µê²©ì— ì·¨ì•½í•©ë‹ˆë‹¤.
      </div>
    </div>
  </div>
</div>

#### ì €ì¥ ë°©ë²• ë¹„êµ

| ë°©ë²• | ë³´ì•ˆì„± | XSS ë°©ì–´ | ê¶Œì¥ ì—¬ë¶€ | ë¹„ê³  |
|------|--------|----------|-----------|------|
| **httpOnly ì¿ í‚¤** | â­â­â­â­â­ | âœ… | âœ… ì¶”ì²œ | JavaScriptì—ì„œ ì ‘ê·¼ ë¶ˆê°€, ê°€ì¥ ì•ˆì „ |
| **ì„œë²„ ì„¸ì…˜** | â­â­â­â­â­ | âœ… | âœ… ì¶”ì²œ | ì„œë²„ ë©”ëª¨ë¦¬/DBì— ì €ì¥, ë§¤ìš° ì•ˆì „ |
| **sessionStorage** | â­â­â­ | âŒ | ğŸ’¡ ì°¸ê³  | XSS ì·¨ì•½ì  ì£¼ì˜ í•„ìš” |
| **localStorage** | â­â­ | âŒ | ğŸ’¡ ì°¸ê³  | XSS ì·¨ì•½ì ì´ ìˆì–´ ì£¼ì˜ í•„ìš” |
| **ë©”ëª¨ë¦¬** | â­â­â­â­ | âœ… | âœ… ì¶”ì²œ | ìƒˆë¡œê³ ì¹¨ ì‹œ ì†ì‹¤, SPAì— ì í•© |

#### BFF íŒ¨í„´ ê¶Œì¥

ê°€ì¥ ì•ˆì „í•œ ë°©ë²•ì€ **BFF (Backend For Frontend)** íŒ¨í„´ì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤:

1. í”„ë¡ íŠ¸ì—”ë“œëŠ” OAuth í”Œë¡œìš°ë¥¼ ì§ì ‘ ì²˜ë¦¬í•˜ì§€ ì•ŠìŒ
2. ë°±ì—”ë“œê°€ PKCE í”Œë¡œìš°ë¥¼ ëŒ€ì‹  ìˆ˜í–‰
3. `code_verifier`ëŠ” ì„œë²„ ì„¸ì…˜ì— ì €ì¥
4. í† í°ë„ httpOnly ì¿ í‚¤ë¡œ ê´€ë¦¬

ìì„¸í•œ êµ¬í˜„ ë°©ë²•ì€ [React + Spring Boot ì˜ˆì œ](/docs/oauth/example/react-spring)ë¥¼ ì°¸ê³ í•˜ì„¸ìš”.

### code_challenge_method ì„¤ì •

ë°˜ë“œì‹œ `S256` (SHA-256)ì„ ì‚¬ìš©í•˜ì„¸ìš”:

```javascript
// âœ… ì˜¬ë°”ë¥¸ ë°©ë²•
{
  code_challenge_method: "S256"
}

// âŒ ì˜ëª»ëœ ë°©ë²• (ë³´ì•ˆ ì·¨ì•½)
{
  code_challenge_method: "plain"
}
```

`plain` ë°©ì‹ì€ `code_verifier`ë¥¼ ê·¸ëŒ€ë¡œ ì „ì†¡í•˜ë¯€ë¡œ, ì¤‘ê°„ì ê³µê²©ì— ì·¨ì•½í•©ë‹ˆë‹¤. OAuth 2.0 ìŠ¤í™ì—ì„œë„ `S256` ì‚¬ìš©ì„ ì œì•ˆí•˜ê³  ìˆìŠµë‹ˆë‹¤.

### ì¼íšŒì„± ì‚¬ìš© (Replay Attack ë°©ì§€)

`code_verifier`ëŠ” **í•œ ë²ˆë§Œ ì‚¬ìš©**í•´ì•¼ í•©ë‹ˆë‹¤:

```javascript
// âœ… ì˜¬ë°”ë¥¸ ë°©ë²•
const codeVerifier = sessionStorage.getItem('oauth_code_verifier');
await exchangeToken(code, codeVerifier);
sessionStorage.removeItem('oauth_code_verifier'); // ì¦‰ì‹œ ì‚­ì œ

// âŒ ì˜ëª»ëœ ë°©ë²•
const codeVerifier = sessionStorage.getItem('oauth_code_verifier');
await exchangeToken(code, codeVerifier);
// ì‚­ì œí•˜ì§€ ì•ŠìŒ â†’ Replay Attack ìœ„í—˜
```

ì„œë²„ë„ ì‚¬ìš©ëœ Authorization Codeë¥¼ ë¬´íš¨í™”í•˜ë¯€ë¡œ, ë™ì¼í•œ Codeë¥¼ ë‘ ë²ˆ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.

### code_verifier ê¸¸ì´

RFC 7636 í‘œì¤€ì— ë”°ë¥´ë©´:

- **ìµœì†Œ ê¸¸ì´**: 43ì
- **ìµœëŒ€ ê¸¸ì´**: 128ì
- **ê¶Œì¥ ê¸¸ì´**: 43-128ì (ì—”íŠ¸ë¡œí”¼ 128ë¹„íŠ¸ ì´ìƒ)

```javascript
// âœ… ì˜¬ë°”ë¥¸ ê¸¸ì´ (43ì)
const array = new Uint8Array(32); // 32 bytes = 256 bits â†’ 43ì Base64URL
crypto.getRandomValues(array);
const codeVerifier = base64UrlEncode(array);

// âŒ ë„ˆë¬´ ì§§ìŒ (ë³´ì•ˆ ì·¨ì•½)
const codeVerifier = "short"; // 5ì â†’ ì˜ˆì¸¡ ê°€ëŠ¥
```

## FAQ

### Q1. PKCEì™€ client_secretì„ í•¨ê»˜ ì‚¬ìš©í•  ìˆ˜ ìˆë‚˜ìš”?

**A.** ê¸°ìˆ ì ìœ¼ë¡œëŠ” ê°€ëŠ¥í•©ë‹ˆë‹¤.

- PKCEë§Œ ì‚¬ìš©í•˜ì…”ë„ ì¶©ë¶„í•œ ë³´ì•ˆì„ ì œê³µí•©ë‹ˆë‹¤
- `client_secret`ì„ í•¨ê»˜ ì‚¬ìš©í•˜ë©´ ê´€ë¦¬ê°€ ì¡°ê¸ˆ ë³µì¡í•´ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤
- ëŒ€ë¶€ë¶„ì˜ OAuth ì œê³µìëŠ” PKCEë¥¼ ì‚¬ìš©í•  ë•Œ `client_secret`ì„ ì„ íƒ ì‚¬í•­ìœ¼ë¡œ ë§Œë“­ë‹ˆë‹¤

**ì œì•ˆ**: ê¼­ í•„ìš”í•˜ì§€ ì•Šë‹¤ë©´ PKCEë§Œ ì‚¬ìš©í•˜ì‹œëŠ” ê²ƒì´ ê´€ë¦¬ê°€ í¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### Q2. ëª¨ë°”ì¼ ì•±ì—ì„œ PKCEë¥¼ ì‚¬ìš©í•˜ëŠ” ë°©ë²•ì€?

**A.** ëª¨ë°”ì¼ ì•±ì€ PKCEì˜ ì£¼ìš” ì‚¬ìš© ì‚¬ë¡€ì…ë‹ˆë‹¤.

#### iOS (Swift)

```swift
import CryptoKit

func generateCodeVerifier() -> String {
    var bytes = [UInt8](repeating: 0, count: 32)
    _ = SecRandomCopyBytes(kSecRandomDefault, bytes.count, &bytes)
    return Data(bytes).base64EncodedString()
        .replacingOccurrences(of: "+", with: "-")
        .replacingOccurrences(of: "/", with: "_")
        .replacingOccurrences(of: "=", with: "")
}

func generateCodeChallenge(verifier: String) -> String {
    let data = verifier.data(using: .utf8)!
    let hash = SHA256.hash(data: data)
    return Data(hash).base64EncodedString()
        .replacingOccurrences(of: "+", with: "-")
        .replacingOccurrences(of: "/", with: "_")
        .replacingOccurrences(of: "=", with: "")
}
```

#### Android (Kotlin)

```kotlin
import java.security.MessageDigest
import java.security.SecureRandom
import java.util.Base64

fun generateCodeVerifier(): String {
    val bytes = ByteArray(32)
    SecureRandom().nextBytes(bytes)
    return Base64.getUrlEncoder()
        .withoutPadding()
        .encodeToString(bytes)
}

fun generateCodeChallenge(verifier: String): String {
    val digest = MessageDigest.getInstance("SHA-256")
    val hash = digest.digest(verifier.toByteArray())
    return Base64.getUrlEncoder()
        .withoutPadding()
        .encodeToString(hash)
}
```

**ì €ì¥ ë°©ë²•**:
- iOS: Keychainì— ì €ì¥
- Android: EncryptedSharedPreferencesì— ì €ì¥

### Q3. SPAì—ì„œ PKCEë¥¼ ì‚¬ìš©í•  ë•Œ ì£¼ì˜ì‚¬í•­ì€?

**A.** SPA (Single Page Application)ì—ì„œ PKCEë¥¼ ì•ˆì „í•˜ê²Œ ì‚¬ìš©í•˜ë ¤ë©´:

#### 1. BFF íŒ¨í„´ ì‚¬ìš© (ê°•ë ¥ ê¶Œì¥)

```
Browser â†’ BFF (Next.js/Express) â†’ OAuth Server
```

BFFê°€ PKCE í”Œë¡œìš°ë¥¼ ëŒ€ì‹  ìˆ˜í–‰í•˜ê³ , í† í°ì„ httpOnly ì¿ í‚¤ë¡œ ê´€ë¦¬í•©ë‹ˆë‹¤.

#### 2. code_verifier ì €ì¥ ì£¼ì˜

SPAì—ì„œ ì§ì ‘ PKCEë¥¼ êµ¬í˜„í•˜ëŠ” ê²½ìš°:

```javascript
// âš ï¸ sessionStorage ì‚¬ìš© ì‹œ (XSS ì£¼ì˜)
sessionStorage.setItem('oauth_code_verifier', codeVerifier);

// âœ… ë” ì•ˆì „í•œ ë°©ë²•: ë©”ëª¨ë¦¬ì—ë§Œ ì €ì¥
class OAuthManager {
  private codeVerifier: string | null = null;

  async initiateOAuth() {
    this.codeVerifier = generateCodeVerifier();
    // ... PKCE í”Œë¡œìš° ì§„í–‰
  }

  async exchangeToken(code: string) {
    if (!this.codeVerifier) throw new Error('No verifier');
    await exchangeToken(code, this.codeVerifier);
    this.codeVerifier = null; // ì¦‰ì‹œ ì‚­ì œ
  }
}
```

#### 3. CSP (Content Security Policy) ì„¤ì •

XSS ê³µê²©ì„ ë°©ì§€í•˜ê¸° ìœ„í•´ CSPë¥¼ ì„¤ì •í•˜ì„¸ìš”:

```html
<meta http-equiv="Content-Security-Policy"
      content="default-src 'self'; script-src 'self' 'unsafe-inline'; ...">
```

#### 4. HTTPS í•„ìˆ˜

ê°œë°œ í™˜ê²½ì—ì„œë„ HTTPSë¥¼ ì‚¬ìš©í•˜ì„¸ìš” (localhost ì œì™¸).

### Q4. PKCE ê²€ì¦ ì‹¤íŒ¨ ì‹œ ì–´ë–»ê²Œ ë””ë²„ê¹…í•˜ë‚˜ìš”?

**A.** ë‹¤ìŒ ì‚¬í•­ì„ í™•ì¸í•˜ì„¸ìš”:

#### 1. code_challenge ìƒì„± í™•ì¸

```javascript
const verifier = "dBjftJeZ4CVP-mB92K27uhbUJU1p1r_wW1gFWFOEjXk";
const challenge = await generateCodeChallenge(verifier);
console.log('Verifier:', verifier);
console.log('Challenge:', challenge);
// Challenge ê°’ì´ ì˜ˆìƒê³¼ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸
```

#### 2. Base64URL ì¸ì½”ë”© í™•ì¸

ì¼ë°˜ Base64ê°€ ì•„ë‹Œ **Base64URL** ì¸ì½”ë”©ì„ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤:

```javascript
// âœ… ì˜¬ë°”ë¥¸ Base64URL
const base64url = base64
  .replace(/\+/g, '-')
  .replace(/\//g, '_')
  .replace(/=+$/, ''); // padding ì œê±°

// âŒ ì¼ë°˜ Base64 (PKCEì—ì„œ ì‚¬ìš© ë¶ˆê°€)
const base64 = btoa(data);
```

#### 3. code_verifier ì €ì¥/ë³µì› í™•ì¸

```javascript
// ì €ì¥
console.log('Storing verifier:', codeVerifier);
sessionStorage.setItem('oauth_code_verifier', codeVerifier);

// ë³µì›
const storedVerifier = sessionStorage.getItem('oauth_code_verifier');
console.log('Retrieved verifier:', storedVerifier);
console.log('Verifiers match:', codeVerifier === storedVerifier);
```

#### 4. SHA-256 í•´ì‹œ í™•ì¸

```javascript
// ìˆ˜ë™ìœ¼ë¡œ ê²€ì¦
async function verifySHA256(verifier, expectedChallenge) {
  const encoder = new TextEncoder();
  const data = encoder.encode(verifier);
  const hash = await crypto.subtle.digest('SHA-256', data);
  const actualChallenge = base64UrlEncode(new Uint8Array(hash));

  console.log('Expected:', expectedChallenge);
  console.log('Actual:', actualChallenge);
  console.log('Match:', expectedChallenge === actualChallenge);
}
```

#### 5. ì„œë²„ ì—ëŸ¬ ë¡œê·¸ í™•ì¸

ì„œë²„ê°€ ë°˜í™˜í•˜ëŠ” ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ í™•ì¸í•˜ì„¸ìš”:

```json
{
  "error": "invalid_grant",
  "error_description": "PKCE verification failed: code_challenge mismatch"
}
```

### Q5. PKCEëŠ” Authorization Code Flowì—ì„œë§Œ ì‚¬ìš©í•˜ë‚˜ìš”?

**A.** ë„¤, PKCEëŠ” **Authorization Code Flow ì „ìš©**ì…ë‹ˆë‹¤.

ë‹¤ë¥¸ OAuth í”Œë¡œìš°ì—ì„œëŠ” ì‚¬ìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤:

- **Implicit Flow**: ì‚¬ìš© ë¶ˆê°€ (Authorization Codeê°€ ì—†ìŒ)
- **Client Credentials Flow**: ì‚¬ìš© ë¶ˆê°€ (ì„œë²„ ê°„ í†µì‹ , `client_secret` ì‚¬ìš©)
- **Resource Owner Password Flow**: ì‚¬ìš© ë¶ˆê°€ (ì‚¬ìš©ì credential ì§ì ‘ ì „ì†¡)

**ì°¸ê³ **: Implicit FlowëŠ” ë³´ì•ˆìƒ ê¶Œì¥í•˜ì§€ ì•Šìœ¼ë©°, í˜„ëŒ€ì ì¸ OAuth êµ¬í˜„ì—ì„œëŠ” **PKCEë¥¼ ì‚¬ìš©í•œ Authorization Code Flow**ë¡œ ëŒ€ì²´ë˜ì—ˆìŠµë‹ˆë‹¤.

## ë‹¤ìŒ ë‹¨ê³„

PKCEì— ëŒ€í•´ ì´í•´í–ˆë‹¤ë©´, ì‹¤ì œ êµ¬í˜„ ì˜ˆì œë¥¼ ì°¸ê³ í•˜ì„¸ìš”:

- [React + Spring Boot ì˜ˆì œ](/docs/oauth/example/react-spring) - BFF íŒ¨í„´ ê¸°ë°˜ PKCE êµ¬í˜„
- [HTTP API ë¬¸ì„œ](/docs/oauth/http/code) - PKCE íŒŒë¼ë¯¸í„° ìƒì„¸ ì„¤ëª…
- [í† í° êµí™˜](/docs/oauth/http/token-exchange) - code_verifier ì‚¬ìš© ë°©ë²•

## ì°¸ê³  ìë£Œ

- [RFC 7636 - Proof Key for Code Exchange](https://datatracker.ietf.org/doc/html/rfc7636)
- [OAuth 2.0 Security Best Current Practice](https://datatracker.ietf.org/doc/html/draft-ietf-oauth-security-topics)
- [OAuth 2.0 for Browser-Based Apps](https://datatracker.ietf.org/doc/html/draft-ietf-oauth-browser-based-apps)
